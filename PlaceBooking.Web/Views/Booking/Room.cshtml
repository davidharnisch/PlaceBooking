@using PlaceBooking.Application.DTOs
@model RoomDto

@{
    var isReadOnly = ViewBag.IsReadOnly as bool? ?? false;
    var composedTitle = isReadOnly ? "Historie | " + Model.Name : "Zabookovat | " + Model.Name;
    ViewBag.Title = composedTitle;
    ViewData["Title"] = composedTitle;

    var currentUserId = ViewBag.CurrentUserId as int? ?? 0;
    var selectedDate = ViewBag.SelectedDate as string;
    var selectedDateRaw = selectedDate ?? DateOnly.FromDateTime(DateTime.Today).ToString("yyyy-MM-dd");
    var selectedDateOnly = DateOnly.Parse(selectedDateRaw);
    var selectedDateDisplay = selectedDateOnly.ToString("dd.MM.yyyy");
    var isSelectedDateNotInPast = selectedDateOnly >= DateOnly.FromDateTime(DateTime.Today);
    var prevDate = selectedDateOnly.AddDays(-1).ToString("yyyy-MM-dd");
    var nextDate = selectedDateOnly.AddDays(1).ToString("yyyy-MM-dd");

    var dateNavigateAction = isReadOnly ? "Occupancy" : "Room";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>@(ViewBag.Title ?? Model.Name)</h2>
    
    <!-- Date Picker Form -->
    <div class="d-flex gap-2 align-items-center">
        <a class="btn btn-outline-primary" asp-action="@dateNavigateAction" asp-route-roomId="@Model.Id" asp-route-date="@prevDate" aria-label="Pøedchozí den" title="Pøedchozí den">
            <i class="bi bi-chevron-left" aria-hidden="true"></i>
        </a>

        <form method="get" asp-action="@dateNavigateAction" class="d-flex gap-2 room-date-form">
            <input type="hidden" name="roomId" value="@Model.Id" />
            <input type="date" name="date" class="form-control room-date-input" value="@selectedDateRaw" />
        </form>

        <a class="btn btn-outline-primary" asp-action="@dateNavigateAction" asp-route-roomId="@Model.Id" asp-route-date="@nextDate" aria-label="Další den" title="Další den">
            <i class="bi bi-chevron-right" aria-hidden="true"></i>
        </a>
    </div>
    <a asp-action="Index" class="btn btn-outline-secondary">Zpìt na pøehled</a>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}

<!-- Legend -->
<div class="mb-3">
    <span class="badge bg-success me-2">Volno</span>
    <span class="badge bg-danger me-2">Obsazeno (Cizí)</span>
    <span class="badge btn-primary me-2">Moje rezervace</span>
</div>

<!-- Seating map (SVG). The SVG is expected at /images/room-<roomId>.svg or can be adjusted later. -->
@{
    var svgPath = Url.Content($"~/images/room-{Model.Id}.svg");
}

<div class="card p-4 bg-light">
    <div class="pb-room-map" data-room-map data-svg-url="@svgPath" data-room-id="@Model.Id"></div>
</div>

    <!-- Single reusable modal -->
    <div class="modal fade" id="seatActionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="seatActionModalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="seatActionModalBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavøít</button>

                    <form id="seatCreateForm" asp-action="Create" method="post" class="d-none">
                        <input type="hidden" name="SeatId" id="seatCreateSeatId" />
                        <input type="hidden" name="RoomId" value="@Model.Id" />
                        <input type="hidden" name="Date" value="@selectedDateRaw" />
                        <button type="submit" class="btn btn-primary">Ano, zabookovat</button>
                    </form>

                    <form id="seatCancelForm" asp-action="Cancel" method="post" class="d-none">
                        <input type="hidden" name="bookingId" id="seatCancelBookingId" />
                        <input type="hidden" name="RoomId" id="@Model.Id" />
                        <input type="hidden" name="date" value="@selectedDateRaw" />
                        <button type="submit" class="btn btn-danger">Ano, zrušit</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

@section Scripts
{
    <script>
        (function () {
            function init() {
                const host = document.querySelector('[data-room-map]');
                if (!host) return;

                const svgUrl = host.getAttribute('data-svg-url');
                if (!svgUrl) return;

                const roomId = host.getAttribute('data-room-id');
                if (!roomId) return;

                const seats = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Seats));
                const currentUserId = @currentUserId;
                const isReadOnly = @(isReadOnly ? "true" : "false");
                const selectedDate = '@selectedDateRaw';
                const isSelectedDateNotInPast = @((isSelectedDateNotInPast) ? "true" : "false");
                const todayRaw = '@DateOnly.FromDateTime(DateTime.Today).ToString("yyyy-MM-dd")';

                function seatNumberFromLabel(label) {
                    // Labels are like "TULLI-1" -> 1
                    if (!label) return null;
                    const m = String(label).match(/-(\d+)$/);
                    return m ? m[1] : null;
                }

                function applySeatState(svg, seatEl, seat) {
                    const isMyBooking = seat.IsBooked && seat.BookedByUserId === currentUserId;
                    const isPastDate = selectedDate < todayRaw;
                    const canCreateBooking = !isReadOnly && !isPastDate;
                    const canCancelBooking = !isReadOnly && isSelectedDateNotInPast;

                    seatEl.classList.add('pb-seat');
                    seatEl.classList.toggle('pb-seat--free', !seat.IsBooked);
                    seatEl.classList.toggle('pb-seat--mine', isMyBooking);
                    seatEl.classList.toggle('pb-seat--busy', seat.IsBooked && !isMyBooking);
                    seatEl.classList.toggle('pb-seat--disabled', (!canCreateBooking && !seat.IsBooked) || (seat.IsBooked && !isMyBooking));

                    let tooltip = 'Volno';
                    if (seat.IsBooked) {
                        const bookedAt = seat.BookedAt ? new Date(seat.BookedAt) : null;
                        const bookedAtText = bookedAt ? bookedAt.toLocaleString('cs-CZ') : '';
                        tooltip = isMyBooking
                            ? `Moje rezervace${bookedAtText ? ' | Vytvoøeno: ' + bookedAtText : ''}`
                            : `Obsazeno: ${seat.BookedBy || ''}${bookedAtText ? ' | Vytvoøeno: ' + bookedAtText : ''}`;
                    }

                    seatEl.setAttribute('data-bs-toggle', 'tooltip');
                    seatEl.setAttribute('data-bs-placement', 'top');
                    seatEl.setAttribute('data-bs-title', tooltip);
                }

                fetch(svgUrl)
                    .then(r => {
                        if (!r.ok) throw new Error('Failed to load SVG: ' + r.status);
                        return r.text();
                    })
                    .then(svgText => {
                        host.innerHTML = svgText;

                        const svg = host.querySelector('svg');
                        if (!svg) return;
                        svg.classList.add('pb-room-map-svg');

                        // map seats by seatNumber derived from label
                        const seatByNumber = new Map();
                        for (const s of seats) {
                            const n = seatNumberFromLabel(s.Label);
                            if (n) seatByNumber.set(String(n), s);
                        }

                        const seatEls = svg.querySelectorAll('[id^="seat-"]');
                        if (!seatEls.length) {
                            console.warn('No seat elements found in SVG. Expected ids like seat-' + roomId + '-1 ...');
                        }

                        seatEls.forEach(seatEl => {
                            const id = seatEl.getAttribute('id') || '';
                            const m = id.match(/^seat-(\d+)-(\d+)$/);
                            if (!m) return;
                            const svgRoomId = m[1];
                            const seatNo = String(parseInt(m[2], 10));
                            if (svgRoomId !== String(roomId)) return;

                            const seat = seatByNumber.get(seatNo);
                            if (!seat) return;

                            let targetEl = seatEl;
                            if (seatEl.children && seatEl.children.length === 1) {
                                targetEl = seatEl.children[0];
                            }

                            applySeatState(svg, targetEl, seat);

                            seatEl.addEventListener('click', () => {
                                const isMyBooking = seat.IsBooked && seat.BookedByUserId === currentUserId;
                                const isPastDate = selectedDate < todayRaw;
                                const canCreateBooking = !isReadOnly && !isPastDate;
                                const canCancelBooking = !isReadOnly && isSelectedDateNotInPast;

                                const modalEl = document.getElementById('seatActionModal');
                                if (!modalEl || !window.bootstrap) return;

                                const titleEl = document.getElementById('seatActionModalTitle');
                                const bodyEl = document.getElementById('seatActionModalBody');
                                const createForm = document.getElementById('seatCreateForm');
                                const cancelForm = document.getElementById('seatCancelForm');
                                const createSeatId = document.getElementById('seatCreateSeatId');
                                const cancelBookingId = document.getElementById('seatCancelBookingId');

                                if (!titleEl || !bodyEl || !createForm || !cancelForm || !createSeatId || !cancelBookingId) return;

                                createForm.classList.add('d-none');
                                cancelForm.classList.add('d-none');

                                if (!seat.IsBooked && canCreateBooking) {
                                    titleEl.textContent = 'Potvrzení rezervace';
                                    bodyEl.innerHTML = `Opravdu chcete zabookovat místo <strong>${seat.Label}</strong> na den ${'@selectedDateDisplay'}?`;
                                    createSeatId.value = seat.Id;
                                    createForm.classList.remove('d-none');
                                    bootstrap.Modal.getOrCreateInstance(modalEl).show();
                                } else if (seat.IsBooked && isMyBooking && canCancelBooking && seat.BookingId) {
                                    titleEl.textContent = 'Zrušit rezervaci';
                                    bodyEl.innerHTML = `Opravdu chcete zrušit svou rezervaci místa <strong>${seat.Label}</strong> pro den ${'@selectedDateDisplay'}?`;
                                    cancelBookingId.value = seat.BookingId;
                                    cancelForm.classList.remove('d-none');
                                    bootstrap.Modal.getOrCreateInstance(modalEl).show();
                                }
                            });
                        });

                        // enable tooltips for dynamically added SVG attributes
                        if (window.bootstrap) {
                            svg.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
                                bootstrap.Tooltip.getOrCreateInstance(el);
                            });
                        }
                    })
                    .catch(err => {
                        console.error('Failed to initialize seating SVG map', err);
                    });
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
}
