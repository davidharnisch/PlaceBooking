@using PlaceBooking.Application.DTOs
@model RoomDto

@{
    var isReadOnly = ViewBag.IsReadOnly as bool? ?? false;
    var composedTitle = isReadOnly ? "Historie | " + Model.Name : "Zabookovat | " + Model.Name;
    ViewBag.Title = composedTitle;
    ViewData["Title"] = composedTitle;

    var currentUserId = ViewBag.CurrentUserId as int? ?? 0;
    var selectedDate = ViewBag.SelectedDate as string;
    var selectedDateRaw = selectedDate ?? DateOnly.FromDateTime(DateTime.Today).ToString("yyyy-MM-dd");
    var selectedDateOnly = DateOnly.Parse(selectedDateRaw);
    var selectedDateDisplay = selectedDateOnly.ToString("dd.MM.yyyy");
    var isSelectedDateNotInPast = selectedDateOnly >= DateOnly.FromDateTime(DateTime.Today);
    var prevDate = selectedDateOnly.AddDays(-1).ToString("yyyy-MM-dd");
    var nextDate = selectedDateOnly.AddDays(1).ToString("yyyy-MM-dd");

    var dateNavigateAction = isReadOnly ? "Occupancy" : "Room";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>@(ViewBag.Title ?? Model.Name)</h2>
    
    <!-- Date Picker Form -->
    <div class="d-flex gap-2 align-items-center">
        <a class="btn btn-outline-primary" asp-action="@dateNavigateAction" asp-route-roomId="@Model.Id" asp-route-date="@prevDate" aria-label="Pøedchozí den" title="Pøedchozí den">
            <i class="bi bi-chevron-left" aria-hidden="true"></i>
        </a>

        <form method="get" asp-action="@dateNavigateAction" class="d-flex gap-2 room-date-form">
            <input type="hidden" name="roomId" value="@Model.Id" />
            <input type="date" name="date" class="form-control room-date-input" value="@selectedDateRaw" />
        </form>

        <a class="btn btn-outline-primary" asp-action="@dateNavigateAction" asp-route-roomId="@Model.Id" asp-route-date="@nextDate" aria-label="Další den" title="Další den">
            <i class="bi bi-chevron-right" aria-hidden="true"></i>
        </a>
    </div>
    <a asp-action="Index" class="btn btn-outline-secondary">Zpìt na pøehled</a>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}

<!-- Legend -->
<div class="mb-3">
    <span class="badge bg-success me-2">Volno</span>
    <span class="badge bg-danger me-2">Obsazeno (Cizí)</span>
    <span class="badge btn-primary me-2">Moje rezervace</span>
</div>

<!-- Seating map (SVG). The SVG is expected at /images/room-<roomId>.svg or can be adjusted later. -->
@{
    var svgPath = Url.Content($"~/images/room-{Model.Id}.svg");
}

<div class="card p-4 bg-light">
    <div class="pb-room-map"
         data-room-map
         data-svg-url="@svgPath"
         data-room-id="@Model.Id"
         data-seats='@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Seats))'
         data-current-user-id="@currentUserId"
         data-read-only="@(isReadOnly ? "true" : "false")"
         data-selected-date="@selectedDateRaw"
         data-selected-date-display="@selectedDateDisplay"
         data-selected-date-not-in-past="@((isSelectedDateNotInPast) ? "true" : "false")"
         data-today="@DateOnly.FromDateTime(DateTime.Today).ToString("yyyy-MM-dd")"></div>
</div>

    <!-- Single reusable modal -->
    <div class="modal fade" id="seatActionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="seatActionModalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="seatActionModalBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavøít</button>

                    <form id="seatCreateForm" asp-action="Create" method="post" class="d-none">
                        <input type="hidden" name="SeatId" id="seatCreateSeatId" />
                        <input type="hidden" name="RoomId" value="@Model.Id" />
                        <input type="hidden" name="Date" value="@selectedDateRaw" />
                        <button type="submit" class="btn btn-primary">Ano, zabookovat</button>
                    </form>

                    <form id="seatCancelForm" asp-action="Cancel" method="post" class="d-none">
                        <input type="hidden" name="bookingId" id="seatCancelBookingId" />
                        <input type="hidden" name="RoomId" id="@Model.Id" />
                        <input type="hidden" name="date" value="@selectedDateRaw" />
                        <button type="submit" class="btn btn-danger">Ano, zrušit</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
